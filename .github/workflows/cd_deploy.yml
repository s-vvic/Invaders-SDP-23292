name: Continuous Delivery (CD) - Artifact Staging

on:
  push:
    branches: [ master, dev ] # â¬…ï¸ ë§ˆìŠ¤í„° ë¸Œëœì¹˜ì— ì½”ë“œê°€ ë³‘í•©ë  ë•Œë§Œ CD ì‹¤í–‰
    paths:
      - 'backend/**' 
      - 'frontend/**' # â¬…ï¸ í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ë³€ê²½ ì‹œì—ë„ CDë¥¼ ì‹¤í–‰í•˜ë„ë¡ ê²½ë¡œ ì¶”ê°€
      - 'src/**'

jobs:
    # 1. ë°±ì—”ë“œ Job (ê¸°ì¡´ Job: Docker ì´ë¯¸ì§€ ë¹Œë“œ)
    deploy_backend: # â¬…ï¸ Job ì´ë¦„ì„ ëª…í™•íˆ 'deploy_backend'ë¡œ ë³€ê²½
      name: Backend Image Build & Tag
      runs-on: ubuntu-latest
    
      # needs: ì„¤ì •ì„ ì œê±°(ì£¼ì„ ì²˜ë¦¬)í•˜ì—¬ CI íŒŒì¼ê³¼ì˜ ì§ì ‘ì ì¸ ì°¸ì¡° ì˜¤ë¥˜ë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
      # needs: [build_and_test_backend_docker] 
    
      steps:
        - name: Checkout Code
          uses: actions/checkout@v4 
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3   
        # 2. ì´ë¯¸ì§€ ë¹Œë“œ ë° íƒœê·¸ ì§€ì • (ë¡œì»¬ Runnerì— ì €ì¥)
        - name: Build and Tag Final Image
          uses: docker/build-push-action@v5
          with:
            context: ./backend # backend í´ë”ë¥¼ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ë¡œ ì‚¬ìš©
            file: ./backend/Dockerfile
            push: false 
            tags: my-backend-repo:latest, my-backend-repo:${{ github.sha }}

    # ----------------------------------------------------
    # 2. í”„ë¡ íŠ¸ì—”ë“œ Job (ìƒˆë¡œ ì¶”ê°€: ì •ì  íŒŒì¼ ë¹Œë“œ ë° ì•„í‹°íŒ©íŠ¸ ì €ì¥)
    deploy_frontend:
      name: Frontend Artifact Upload
      runs-on: ubuntu-latest
    
      steps:
        - name: Checkout Code
          uses: actions/checkout@v4

        # ğŸš¨ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ìŠ¤í… (ì„ íƒ ì‚¬í•­: í•„ìš”í•œ ê²½ìš°)
        # React, Vue, Angular ë“±ì„ ì‚¬ìš©í•œë‹¤ë©´ ì—¬ê¸°ì— ë¹Œë“œ ëª…ë ¹ì–´ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        # í˜„ì¬ëŠ” ì •ì  íŒŒì¼ì´ë¼ê³  ê°€ì •í•˜ê³  ì••ì¶•ë§Œ ì§„í–‰í•©ë‹ˆë‹¤.

        - name: Archive Frontend Files
          # tar ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ frontend í´ë” ì „ì²´ë¥¼ ì••ì¶•í•©ë‹ˆë‹¤.
          run: tar -czf frontend-dist-${{ github.sha }}.tar.gz -C frontend .

        - name: Upload Frontend Artifact
          uses: actions/upload-artifact@v4
          with:
            name: frontend-dist-${{ github.sha }}
            path: frontend-dist-${{ github.sha }}.tar.gz

    # ----------------------------------------------------
    deploy_java_backend:
        name: Java Artifact Upload (Compiled)
        runs-on: ubuntu-latest
        
        steps:
          - name: Checkout Code
            uses: actions/checkout@v4

          # 1. JDK ì„¤ì •
          - name: Set up JDK 17
            uses: actions/setup-java@v4
            with:
              java-version: '17'
              distribution: 'temurin'

          # 2. ì»´íŒŒì¼ ë° .class íŒŒì¼ ìƒì„±
          - name: Compile Java Code to Binaries
            run: |
              mkdir -p bin # ì»´íŒŒì¼ ê²°ê³¼ ì €ì¥ í´ë” ìƒì„±
              cp -r src .  # ë£¨íŠ¸ì˜ src í´ë”ë¥¼ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
              # ì»´íŒŒì¼: CIì™€ ë™ì¼í•˜ê²Œ ì‹¤í–‰
              javac -d bin $(find src -name "*.java")
            
          # 3. ì»´íŒŒì¼ëœ ê²°ê³¼ë¬¼(.class íŒŒì¼) ì••ì¶•
          - name: Archive Compiled Java Binaries
            # bin í´ë”ì˜ ëª¨ë“  .class íŒŒì¼ì„ ì••ì¶•í•˜ì—¬ Java ì•„í‹°íŒ©íŠ¸ë¥¼ ë§Œë“­ë‹ˆë‹¤.
            run: tar -czf java-backend-binaries-${{ github.sha }}.tar.gz -C bin .
            
          # 4. ì•„í‹°íŒ©íŠ¸ ì €ì¥
          - name: Upload Java Artifact
            uses: actions/upload-artifact@v4
            with:
              name: java-backend-binaries-${{ github.sha }}
              path: java-backend-binaries-${{ github.sha }}.tar.gz