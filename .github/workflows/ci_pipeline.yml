name: Backend Node.js CI (Docker í™˜ê²½ ì‚¬ìš©)

on:
  pull_request: 
    branches: [ master, dev ]
    paths:
      - 'backend/**' 
  push:
    branches: [ master, dev ]

jobs:
  build_and_test_backend_docker:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Docker í™˜ê²½ ì„¤ì • (í•„ìˆ˜)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 2. .env íŒŒì¼ ì‹œí¬ë¦¿ ì„¤ì • (ì´ì „ì— í•´ê²°í–ˆë˜ í™˜ê²½ ë³€ìˆ˜ ë¬¸ì œ)
      # ë¡œì»¬ .env íŒŒì¼ì„ ì»¤ë°‹í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, CIì—ì„œ í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ ë³€ìˆ˜ë¥¼ Secretìœ¼ë¡œ ì£¼ì…í•©ë‹ˆë‹¤.
      # - name: Create .env file for Test
      #   run: |
      #     echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> ./backend/.env.test
      #     # í•„ìš”í•œ ë‹¤ë¥¸ í™˜ê²½ ë³€ìˆ˜ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€í•©ë‹ˆë‹¤.
      #   # ğŸš¨ ì£¼ì˜: JWT_SECRETì€ GitHub Secretsì— ë“±ë¡ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

      # 3. Docker Composeë¡œ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Build and Run Tests via Docker Compose
        run: |
          # ğŸš¨ Docker Composeì˜ í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ì„ ì‚¬ìš©
          # -f ì˜µì…˜ìœ¼ë¡œ docker-compose.yml íŒŒì¼ ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
          # --build: ì´ë¯¸ì§€ë¥¼ ìƒˆë¡œ ë¹Œë“œí•©ë‹ˆë‹¤. (ìµœì‹  ì½”ë“œ ë°˜ì˜)
          # node-backend: í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•  ì„œë¹„ìŠ¤ ì´ë¦„ (docker-compose.ymlì˜ ì„œë¹„ìŠ¤ ì´ë¦„)
          docker compose -f docker-compose.yml run --rm node-backend npm test
        
        # ğŸš¨ ì¤‘ìš”: docker-compose.yml íŒŒì¼ì´ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìˆê³ ,
        # Node.js ì„œë¹„ìŠ¤ ì´ë¦„ì´ 'node-backend'ì—¬ì•¼ ìœ„ ëª…ë ¹ì–´ê°€ ì‘ë™í•©ë‹ˆë‹¤.