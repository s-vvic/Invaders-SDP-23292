name: Backend Node.js CI (Docker í™˜ê²½ ì‚¬ìš©)

on:
  pull_request: 
    branches: [ master, dev ]
    paths:
      - 'backend/**' 
  push:
    branches: [ master, dev ]

jobs:
  build_and_test_backend_docker:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Docker í™˜ê²½ ì„¤ì • (í•„ìˆ˜)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 2. CI ì „ìš© Docker Compose íŒŒì¼ ì‚¬ìš© ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Build and Run Tests via Docker Compose
        run: |
          # ğŸš¨ ìˆ˜ì •: docker-compose.yml ëŒ€ì‹  docker-compose.ci.yml íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
          # JWT_SECRETì€ --env í”Œë˜ê·¸ë¥¼ í†µí•´ ì§ì ‘ ì»¨í…Œì´ë„ˆì— ì£¼ì…í•©ë‹ˆë‹¤.
          docker compose -f docker-compose.ci.yml run --rm \
            --env JWT_SECRET="$'{{ secrets.JWT_SECRET }}'" \
            backend npm test