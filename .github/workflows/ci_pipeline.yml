name: Backend Node.js CI (Docker í™˜ê²½ ì‚¬ìš©)

on:
  pull_request: 
    branches: [ master, dev ]
    paths:
      - 'backend/**' 
  push:
    branches: [ master, dev ]

jobs:
  build_and_test_backend_docker:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Docker í™˜ê²½ ì„¤ì • (í•„ìˆ˜)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 2. CI ì „ìš© Docker Compose íŒŒì¼ ì‚¬ìš© ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Build and Run Tests via Docker Compose
        run: |
          # ğŸš¨ ìˆ˜ì •: docker-compose.yml ëŒ€ì‹  docker-compose.ci.yml íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
          # JWT_SECRETì€ --env í”Œë˜ê·¸ë¥¼ í†µí•´ ì§ì ‘ ì»¨í…Œì´ë„ˆì— ì£¼ì…í•©ë‹ˆë‹¤.
          docker compose -f docker-compose.ci.yml run --rm \
            --env JWT_SECRET="$'{{ secrets.JWT_SECRET }}'" \
            backend npm test

  # 2. Java ë°±ì—”ë“œ CI Job (ìƒˆë¡œ ì¶”ê°€)
  build_and_test_java:
    name: Java Code Compile & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
    
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17' # â¬…ï¸ íŒ€ì—ì„œ ì‚¬ìš©í•˜ëŠ” JDK ë²„ì „ìœ¼ë¡œ ë³€ê²½
          distribution: 'temurin'
          
      # ğŸš¨ Java CIì˜ í•µì‹¬: .class íŒŒì¼ì„ ìƒì„±í•˜ëŠ” ì»´íŒŒì¼ ë‹¨ê³„
      - name: Compile Java Code
        # ìë°” í”„ë¡œì íŠ¸ì˜ ë£¨íŠ¸ í´ë”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì»´íŒŒì¼ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
        # -d bin: ì»´íŒŒì¼ëœ .class íŒŒì¼ì„ 'bin' í´ë”ì— ì €ì¥í•˜ë„ë¡ ì§€ì •í•©ë‹ˆë‹¤.
        run: javac -d bin $(find src -name "*.java")
        # âš ï¸ í˜„ì¬ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬(JAR íŒŒì¼) ì˜ì¡´ì„±ì´ ì—†ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
        
      # ğŸš¨ Java í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë‹¨ê³„ (í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ê°€ ì—†ë‹¤ê³  ê°€ì •)
      # ì‹¤ì œë¡œëŠ” JUnit ë“± í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ê°€ ìˆì–´ì•¼ í•˜ì§€ë§Œ, í˜„ì¬ í™˜ê²½ì—ì„œëŠ”
      # í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ìˆëŠ”ì§€ í™•ì¸ì´ ì–´ë ¤ìš°ë¯€ë¡œ, ì»´íŒŒì¼ ì„±ê³µë§Œìœ¼ë¡œ CI í†µê³¼ë¥¼ ê°„ì£¼í•©ë‹ˆë‹¤.
      # 
        
      - name: Verify Compilation Artifacts
        # bin í´ë”ì— .class íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        run: |
          if [ -d "bin" ] && [ "$(ls -A bin)" ]; then
            echo "Java compilation succeeded. .class files found in bin/."
          else
            echo "Java compilation failed or no source files found."
            exit 1
          fi